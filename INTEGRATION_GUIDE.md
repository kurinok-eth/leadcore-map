# Руководство по интеграции с 1С-Битрикс

## Проблема: данные не отображаются на карте

### Причина

React-приложение ожидает данные в определенном формате через `window.bitrixMapData`, но Битрикс предоставляет данные с другими названиями полей.

#### Что ожидает React (src/types.ts):

```typescript
interface Representative {
  id: number;           // ID элемента
  name: string;         // ФИО (из NAME элемента)
  position: string;     // Должность
  phone: string;        // Телефон
  email: string;        // Email
  regionId: string | string[];  // ID региона или массив ID
  activity?: string[];  // Направления работы (опционально)
  workingHours?: string; // График работы (опционально)
  photo?: string;       // Фото (опционально)
}
```

#### Что дает Битрикс (по умолчанию):

```php
[
  'ID' => 123,
  'NAME' => 'Иванов Иван Иванович',
  'PROPERTY_REGION_ID_VALUE' => 'ЦФО',
  'PROPERTY_PHONE_VALUE' => '+7 913 384 35 50',
  'PROPERTY_EMAIL_VALUE' => 'ivanov@leadcore.ru',
  // и т.д.
]
```

### Решение

Нужно преобразовать данные из Битрикс в нужный формат в файле `component.php`.

## Пример component.php

См. файл `bitrix-component-example/component.php` — он уже содержит правильное преобразование данных:

```php
$representative = [
    'id' => (int)$arElement['ID'],
    'name' => $arElement['NAME'],
    'position' => $position ?: 'Представитель',
    'phone' => $phone ?: '',
    'email' => $email ?: '',
    'regionId' => $regionIdProcessed,  // может быть строкой или массивом
];
```

## Обработка множественных округов

Если представитель работает в нескольких округах, в поле `REGION_ID` указывается строка через запятую:

```
REGION_ID = "ЦФО,СЗФО"
```

`component.php` автоматически преобразует это в массив:

```php
if (strpos($regionId, ',') !== false) {
    $regionIdProcessed = array_map('trim', explode(',', $regionId));
}
// Результат: ['ЦФО', 'СЗФО']
```

React-приложение обработает это через функцию `isRepresentativeInRegion()` из `src/utils.ts`.

## Символьные коды свойств

**КРИТИЧЕСКИ ВАЖНО:** В настройках инфоблока символьные коды свойств должны **точно совпадать** с теми, что используются в `component.php`:

| Свойство | Символьный код | Используется как |
|----------|----------------|------------------|
| ID Региона | `REGION_ID` | `$arElement['PROPERTY_REGION_ID_VALUE']` |
| Телефон | `PHONE` | `$arElement['PROPERTY_PHONE_VALUE']` |
| E-mail | `EMAIL` | `$arElement['PROPERTY_EMAIL_VALUE']` |
| Должность | `POSITION` | `$arElement['PROPERTY_POSITION_VALUE']` |
| Адрес | `ADDRESS` | `$arElement['PROPERTY_ADDRESS_VALUE']` |
| Направление деятельности | `ACTIVITY` | через `GetProperty()` |
| График работы | `WORKING_HOURS` | `$arElement['PROPERTY_WORKING_HOURS_VALUE']` |

Если в вашем инфоблоке используются **другие** символьные коды (например, `Region_Id` вместо `REGION_ID`), нужно либо:

1. **Переименовать символьные коды** в настройках инфоблока (рекомендуется)
2. **Изменить `component.php`**, чтобы он использовал ваши коды

### Пример изменения component.php под другие коды

Если в вашем инфоблоке используется код `Region_Id` вместо `REGION_ID`:

```php
// Было:
$regionId = $arElement['PROPERTY_REGION_ID_VALUE'];

// Стало:
$regionId = $arElement['PROPERTY_Region_Id_VALUE'];
```

## Отладка

### 1. Проверить, что данные передаются из PHP в JavaScript

Откройте страницу с компонентом, откройте консоль браузера (F12) и выполните:

```javascript
console.log(window.bitrixMapData);
```

**Ожидаемый результат:**

```javascript
[
  {
    id: 1,
    name: "Иванов Иван Иванович",
    position: "Региональный менеджер",
    phone: "+7 913 384 35 50",
    email: "ivanov@leadcore.ru",
    regionId: "ЦФО"
  },
  // ...
]
```

**Если видите `undefined`** — данные не передаются из PHP. Проверьте:
- Есть ли активные элементы в инфоблоке
- Правильно ли указан `$iblockId` в `component.php`
- Вызывается ли `$this->IncludeComponentTemplate()` в конце `component.php`

**Если видите неправильную структуру** — проверьте символьные коды свойств в инфоблоке.

### 2. Проверить, что React получает данные

В консоли выполните:

```javascript
// Посмотреть сколько представителей загружено
console.log('Представителей:', window.bitrixMapData?.length);

// Проверить структуру первого представителя
console.log('Первый:', window.bitrixMapData?.[0]);
```

### 3. Проверить работу фильтра по регионам

```javascript
// Импортировать функцию из utils (через глобальное окно не доступна)
// Нужно проверять через клик на регион в UI
```

Кликните на регион на карте — в правой панели должны появиться представители.

**Если панель пустая:**
- Проверьте значение `regionId` у представителей
- Проверьте, что коды регионов соответствуют константам из `src/constants.ts`
- Для округов используйте `ЦФО`, `СЗФО` и т.д. (не полные названия)

## Частые ошибки

### 1. "Нет представителей в данном регионе"

**Причина:** Неправильное значение `regionId`

**Решение:**
- Для округа: используйте `ЦФО`, `СЗФО`, `ЮФО`, `СКФО`, `ПФО`, `УФО`, `СФО`, `ДФО`
- Для региона: используйте `RU-XXX` (например, `RU-MOW`, `RU-SPE`, `RU-KYA`)

### 2. Телефон и email не отображаются

**Причина:** Поля не заполнены в инфоблоке ИЛИ неправильные символьные коды свойств

**Решение:**
- Проверить, что свойства `PHONE` и `EMAIL` заполнены у элементов
- Проверить, что символьные коды свойств — `PHONE` и `EMAIL` (не `phone`, `Phone_number` и т.д.)

### 3. ФИО обрезается на карточке

**Исправлено** в версии от 29.01.2026 — добавлен `break-words` для переноса строк.

### 4. Компонент не появляется в списке Битрикс

**Причина:** Отсутствует `.description.php`

**Решение:** Создать файл `/local/components/custom/russia.map/.description.php` (см. `bitrix-component-example/.description.php`)

## Тестирование интеграции

Перед запуском в продакшн проверьте:

- [ ] Карта загружается без ошибок в консоли
- [ ] При клике на регион открывается панель с представителями
- [ ] Телефоны отображаются и работают как ссылки `tel:`
- [ ] Email отображается и работает как ссылка `mailto:`
- [ ] Представитель с округом (например, `ЦФО`) виден во **всех** регионах этого округа
- [ ] Представитель с конкретным регионом (например, `RU-MOW`) виден **только** в этом регионе
- [ ] Переключатель "КАРТА" / "СПИСОК" работает
- [ ] Поиск в списке работает по имени, региону, округу
- [ ] Статистика внизу страницы отображается корректно

## Поддержка

Если возникли проблемы:

1. Проверьте консоль браузера (F12 → Console) на наличие ошибок JavaScript
2. Проверьте `window.bitrixMapData` в консоли
3. Проверьте символьные коды свойств в настройках инфоблока
4. Проверьте значения `regionId` у элементов — должны быть коды из документации
5. Убедитесь, что `component.php` правильно преобразует данные

Для детальной отладки можно добавить в `component.php` перед `$this->IncludeComponentTemplate()`:

```php
// ТОЛЬКО ДЛЯ ОТЛАДКИ! Удалить в продакшн
echo '<pre>';
print_r($arResult['REPRESENTATIVES']);
echo '</pre>';
```

Это покажет, какие данные передаются в шаблон.
