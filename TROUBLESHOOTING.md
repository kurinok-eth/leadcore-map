# Решение проблем (Troubleshooting)

## Ошибка: "Element with id 'russia-map-root' not found"

### Симптомы:
- В консоли браузера ошибка: `Element with id "russia-map-root" not found`
- Карта не отображается на странице
- В консоли видны другие ошибки JavaScript

### Причина:
React-скрипт загружается, но контейнер `<div id="russia-map-root">` не создается в DOM.

### Диагностика:

#### Шаг 1: Проверить исходный код страницы

1. Откройте страницу с компонентом в браузере
2. Правый клик → **"Просмотр кода страницы"** (View Page Source)
3. Найдите в коде строку `<div id="russia-map-root"></div>`

**Результат А: строка ЕСТЬ**
- Контейнер создается, но скрипт загружается раньше → см. "Решение А"

**Результат Б: строки НЕТ**
- template.php не подключается или выдает ошибку → см. "Решение Б"

---

### Решение А: Контейнер создается, но слишком поздно

Если `<div id="russia-map-root">` есть в коде страницы, но скрипт его не находит, возможно проблема в порядке загрузки.

**Решение:** Используйте отладочную версию template.php:

1. Переименуйте текущий `template.php` в `template-old.php`
2. Скопируйте `bitrix-component-example/template-debug.php` → `template.php`
3. Обновите страницу
4. Вы увидите желтый и зеленый блоки с отладочной информацией
5. Откройте консоль (F12) — там будут сообщения `DEBUG:`

Это покажет, на каком этапе происходит ошибка.

---

### Решение Б: template.php не подключается

Если `<div id="russia-map-root">` отсутствует в исходном коде страницы:

#### Проверка 1: Правильно ли вызван компонент?

Убедитесь, что на странице есть:

```php
<?php
$APPLICATION->IncludeComponent(
    "custom:russia.map",
    ".default",
    [],
    false
);
?>
```

**НЕ:**
```php
<?php include_once("/local/components/custom/russia.map/component.php"); ?>
```

#### Проверка 2: Есть ли ошибки PHP в component.php?

Добавьте в начало `component.php` (сразу после `<?php`):

```php
error_reporting(E_ALL);
ini_set('display_errors', 1);
```

Обновите страницу. Если есть ошибки PHP — они отобразятся.

#### Проверка 3: Вызывается ли $this->IncludeComponentTemplate()?

Откройте `component.php`, найдите **последнюю строку**:

```php
// Подключение шаблона
$this->IncludeComponentTemplate();
```

Если её нет — добавьте.

#### Проверка 4: Правильный ли путь к template.php?

Путь должен быть:
```
/local/components/custom/russia.map/templates/.default/template.php
```

Проверьте:
- Нет ли лишних папок?
- Правильно ли название папки `templates` (не `template`)?
- Есть ли папка `.default`?

#### Проверка 5: ID инфоблока установлен?

Откройте `component.php`, найдите строку:

```php
$iblockId = 0; // TODO: укажите ID вашего инфоблока
```

Если `$iblockId = 0`, компонент **не загрузит данные**, но template.php должен подключиться. Если template не подключается — проблема в другом.

---

## Ошибка: Карта загружается, но нет представителей

### Симптомы:
- Карта отображается
- При клике на регион — "Нет представителей в данном регионе"
- Или панель справа показывает "Выберите регион"

### Диагностика:

#### Шаг 1: Проверить window.bitrixMapData

Откройте консоль (F12) и выполните:

```javascript
console.log(window.bitrixMapData);
```

**Результат А: `undefined`**
- Данные не передаются из PHP → см. "Решение: Данные не передаются"

**Результат Б: `[]` (пустой массив)**
- Данные не загружаются из инфоблока → см. "Решение: Инфоблок пустой"

**Результат В: массив с данными, но неправильная структура**
- Проблема в символьных кодах свойств → см. "Решение: Неправильная структура данных"

**Результат Г: массив с правильными данными**
- Проблема в значениях `regionId` → см. "Решение: Неправильные коды регионов"

---

### Решение: Данные не передаются

Если `window.bitrixMapData === undefined`:

1. Проверьте, что в template.php есть:
   ```php
   <script>
       window.bitrixMapData = <?= json_encode($arResult['REPRESENTATIVES'], ...) ?>;
   </script>
   ```

2. Проверьте, что этот скрипт идет **ПЕРЕД** подключением `script.js`:
   ```html
   <script>window.bitrixMapData = [...];</script>
   <div id="russia-map-root"></div>
   <script src="/local/components/.../script.js"></script>
   ```

---

### Решение: Инфоблок пустой

Если `window.bitrixMapData === []`:

1. Откройте component.php
2. Найдите строку `$iblockId = 0;`
3. Замените `0` на **ID вашего инфоблока** (посмотреть в админке: Настройки → Информационные блоки)
4. Убедитесь, что в инфоблоке есть **активные элементы** (`ACTIVE = Y`)

**Отладка:** Добавьте в component.php перед `$this->IncludeComponentTemplate()`:

```php
// ТОЛЬКО ДЛЯ ОТЛАДКИ
echo '<pre>Найдено элементов: ' . count($arResult['REPRESENTATIVES']) . '</pre>';
if (count($arResult['REPRESENTATIVES']) > 0) {
    echo '<pre>';
    print_r($arResult['REPRESENTATIVES'][0]);
    echo '</pre>';
}
```

---

### Решение: Неправильная структура данных

Если `window.bitrixMapData` содержит объекты, но в них нет полей `id`, `name`, `phone`, `email`, `regionId`:

**Причина:** Неправильные символьные коды свойств в инфоблоке.

**Проверка:**

1. Откройте админку Битрикс
2. Настройки → Информационные блоки → ваш инфоблок → вкладка **"Свойства"**
3. Проверьте **символьные коды** (колонка "Код"):
   - ✅ Должно быть: `REGION_ID`, `PHONE`, `EMAIL`, `POSITION`
   - ❌ НЕ должно быть: `region_id`, `Region_Id`, `phone_number`, `tel`

Если коды неправильные — либо:
- **Вариант А:** Переименуйте коды в админке (рекомендуется)
- **Вариант Б:** Измените component.php, чтобы он использовал ваши коды

Пример для варианта Б:

```php
// Было:
$phone = $arElement['PROPERTY_PHONE_VALUE'];

// Стало (если ваш код свойства — phone_number):
$phone = $arElement['PROPERTY_phone_number_VALUE'];
```

---

### Решение: Неправильные коды регионов

Если данные в `window.bitrixMapData` есть, но при клике на регион ничего не показывается:

**Причина:** Значение `regionId` у представителя не соответствует коду региона на карте.

**Проверка:**

1. В консоли выполните:
   ```javascript
   console.log('RegionId первого представителя:', window.bitrixMapData[0].regionId);
   ```

2. Сравните с правильными кодами:
   - Для федерального округа: `ЦФО`, `СЗФО`, `ЮФО`, `СКФО`, `ПФО`, `УФО`, `СФО`, `ДФО`
   - Для региона: `RU-MOW`, `RU-SPE`, `RU-KYA` и т.д.

**Частые ошибки:**

❌ `"Центральный федеральный округ"` → ✅ `"ЦФО"`
❌ `"Москва"` → ✅ `"RU-MOW"`
❌ `"moscow"` → ✅ `"RU-MOW"`
❌ `"77"` (код региона РФ) → ✅ `"RU-MOW"`

**Исправление:**

Откройте инфоблок в админке и исправьте значения свойства `REGION_ID` у элементов.

См. полный список кодов в [BITRIX_ADMIN_GUIDE.md](BITRIX_ADMIN_GUIDE.md)

---

## Ошибка: Карта "серая" (не загружается)

### Симптомы:
- Вместо карты — серый прямоугольник
- В консоли ошибка: `Failed to load resource: 404` для `russia-regions.geojson`

### Решение:

Файл GeoJSON не найден. Проверьте:

1. Файл должен быть по пути:
   ```
   /local/components/custom/russia.map/templates/.default/russia-regions.geojson
   ```

2. Скопируйте файл из `public/russia-regions.geojson` в эту папку

3. Проверьте права доступа (файл должен быть читаемым)

---

## Ошибка: jQuery.Deferred exception

### Симптомы:
- В консоли много ошибок вида `jQuery.Deferred exception: $ is not a function`
- Ошибки связаны с другими скриптами сайта (не с картой)

### Причина:

React-бандл может конфликтовать с другими JavaScript-библиотеками на странице (jQuery, Bitrix JS и т.д.).

### Решение:

Это **не критично** для работы карты, если карта отображается. Эти ошибки относятся к другим скриптам вашего сайта, которые пытаются использовать jQuery.

Если карта не работает из-за этого, попробуйте:

1. Подключить компонент в самом конце страницы (перед `</body>`)
2. Обернуть весь компонент в iframe (изоляция)

---

## Общая отладка: Чек-лист проверки

Если ничего не помогает, проверьте по порядку:

- [ ] Файлы компонента на месте:
  - [ ] `/local/components/custom/russia.map/.description.php`
  - [ ] `/local/components/custom/russia.map/component.php`
  - [ ] `/local/components/custom/russia.map/templates/.default/template.php`
  - [ ] `/local/components/custom/russia.map/templates/.default/script.js`
  - [ ] `/local/components/custom/russia.map/templates/.default/style.css`
  - [ ] `/local/components/custom/russia.map/templates/.default/russia-regions.geojson`

- [ ] В component.php:
  - [ ] Указан правильный `$iblockId`
  - [ ] Вызывается `$this->IncludeComponentTemplate()`
  - [ ] Нет ошибок PHP (включить `display_errors`)

- [ ] В инфоблоке:
  - [ ] Свойства с кодами `REGION_ID`, `PHONE`, `EMAIL`, `POSITION`
  - [ ] Есть активные элементы
  - [ ] Поля заполнены (особенно `REGION_ID`)

- [ ] На странице:
  - [ ] Компонент вызван через `$APPLICATION->IncludeComponent(...)`
  - [ ] В исходном коде есть `<div id="russia-map-root">`
  - [ ] В консоли `window.bitrixMapData` содержит массив объектов

- [ ] Коды регионов:
  - [ ] Используются правильные коды (см. BITRIX_ADMIN_GUIDE.md)
  - [ ] Для округов: `ЦФО`, `СЗФО`, `ЮФО`, `СКФО`, `ПФО`, `УФО`, `СФО`, `ДФО`
  - [ ] Для регионов: `RU-XXX` (например, `RU-MOW`, `RU-SPE`)

---

## Нужна помощь?

Если проблема не решается:

1. Используйте **отладочную версию** template.php (`template-debug.php`)
2. Сделайте скриншоты:
   - Консоли браузера (F12 → Console)
   - Вывода `console.log(window.bitrixMapData)`
   - Желтых/зеленых блоков из `template-debug.php`
3. Проверьте исходный код страницы (View Page Source)
4. Проверьте настройки инфоблока (скриншот свойств с символьными кодами)

С этими данными будет проще диагностировать проблему.
